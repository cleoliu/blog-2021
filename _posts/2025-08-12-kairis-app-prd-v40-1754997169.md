---
layout: post
title: "Kairis App - 產品需求文件 (PRD) v4.0 (最終版)"
date: 2025-08-12 19:12:49 +0800
categories: []
tags: []
description: "Kairis App - 產品需求文件 (PRD) v4.0 (最終版)"

---

```markdown
---
title: Building a Real-time Stock Price Viewer with Django
date: 2025-08-12 20:39:07 +0800
categories:
  - Django
  - Python
  - Web Development
tags:
  - real-time
  - stock market
  - API
  - AJAX
  - frontend
description: Learn how to build a basic real-time stock price viewer using Django and a public stock API, incorporating AJAX for dynamic updates.
---

## 1. 導言 (Introduction)

在這個資訊爆炸的時代，即時的金融數據對於投資者和市場觀察者來說至關重要。本教學文章將引導您使用 Python 的 Django 框架，建立一個能夠顯示即時股價的簡單網路應用程式。我們將整合一個外部股票數據 API，並利用 AJAX 技術實現股價的即時更新，讓使用者無需重新整理頁面即可看到最新的價格變動。

本文的目標是：
*   設定一個基本的 Django 專案和應用程式。
*   整合第三方股票數據 API。
*   建立後端視圖來處理數據請求。
*   設計前端介面以顯示和更新股價。
*   使用 JavaScript (AJAX) 實現資料的非同步載入和「即時」更新（透過週期性請求）。

雖然這裡的「即時」是透過週期性查詢（polling）實現的，但對於許多應用場景已足夠。未來您可以探索 WebSocket 等技術來實現更低延遲的真正即時更新。

## 2. 前置需求 (Prerequisites)

在開始之前，請確保您的開發環境已具備以下工具和知識：

*   **Python 3.8+**: 您可以從 [Python 官方網站](https://www.python.org/downloads/) 下載並安裝。
*   **pip**: Python 的套件管理工具，通常隨 Python 一同安裝。
*   **Django**: 一個高階 Python Web 框架。
*   **requests**: 一個簡單易用的 HTTP 函式庫，用於向外部 API 發送請求。
*   **一個股票數據 API 金鑰**:
    *   **Alpha Vantage**: 這是一個提供免費層級的股票數據 API，適合初學者使用。請前往 [Alpha Vantage 網站](https://www.alphavantage.co/support/#api-key) 註冊並獲取您的 API 金鑰。
*   **基礎的 Python 知識**: 理解函式、變數、資料結構等。
*   **基礎的 Django 知識**: 理解專案、應用程式、視圖、URL 路由、模板等概念。
*   **基礎的 HTML、CSS 和 JavaScript 知識**: 用於建立前端介面和處理 AJAX 請求。

## 3. 實作步驟 (Implementation Steps)

以下是建立即時股價應用程式的詳細步驟：

### 步驟 3.1 - 專案與應用程式初始化

首先，我們建立一個新的 Django 專案和一個名為 `stocks` 的應用程式。

```bash
# 建立虛擬環境 (建議)
python -m venv venv
source venv/bin/activate  # macOS/Linux
# venv\Scripts\activate  # Windows

# 安裝 Django 和 requests
pip install django requests

# 建立 Django 專案
django-admin startproject stock_viewer .

# 建立 Django 應用程式
python manage.py startapp stocks
```text
接著，將新建立的 `stocks` 應用程式加入到 `stock_viewer/settings.py` 的 `INSTALLED_APPS` 列表中：

```python
# stock_viewer/settings.py

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'stocks',  # 新增這一行
]
```text
### 步驟 3.2 - 設定 API 金鑰

為了安全和方便管理，我們將 Alpha Vantage API 金鑰儲存在 `settings.py` 中。在實際生產環境中，建議使用環境變數（如 `python-dotenv`）來管理敏感資訊。

在 `stock_viewer/settings.py` 檔案的末尾，加入您的 API 金鑰：

```python
# stock_viewer/settings.py

# ... (檔案其他內容)

# Alpha Vantage API Key
ALPHA_VANTAGE_API_KEY = 'YOUR_ALPHA_VANTAGE_API_KEY' # 請替換為您實際的金鑰
```text
### 步驟 3.3 - 建立 API 服務函式

為了更好地組織程式碼，我們將處理外部 API 請求的邏輯放在一個單獨的服務檔案中。

在 `stocks` 應用程式目錄下，建立一個新檔案 `stocks/services.py`：

```python
# stocks/services.py

import requests
import os
from django.conf import settings

def get_stock_quote(symbol):
    """
    從 Alpha Vantage API 獲取指定股票代碼的即時報價。
    """
    api_key = settings.ALPHA_VANTAGE_API_KEY
    base_url = "https://www.alphavantage.co/query"
    params = {
        "function": "GLOBAL_QUOTE",
        "symbol": symbol,
        "apikey": api_key
    }

    try:
        response = requests.get(base_url, params=params)
        response.raise_for_status() # 對於 4xx/5xx 錯誤拋出 HTTPError

        data = response.json()

        # 檢查 API 返回的數據結構
        if "Global Quote" in data:
            quote = data["Global Quote"]
            # Alpha Vantage 返回的鍵名有前綴，我們將其清理
            cleaned_quote = {
                "symbol": quote.get("01. symbol"),
                "open": quote.get("02. open"),
                "high": quote.get("03. high"),
                "low": quote.get("04. low"),
                "price": quote.get("05. price"),
                "volume": quote.get("06. volume"),
                "latest_trading_day": quote.get("07. latest trading day"),
                "previous_close": quote.get("08. previous close"),
                "change": quote.get("09. change"),
                "change_percent": quote.get("10. change percent")
            }
            return cleaned_quote
        elif "Error Message" in data:
            print(f"API Error: {data['Error Message']}")
            return None
        else:
            print("Unexpected API response structure:", data)
            return None

    except requests.exceptions.HTTPError as http_err:
        print(f"HTTP error occurred: {http_err}")
        return None
    except requests.exceptions.ConnectionError as conn_err:
        print(f"Connection error occurred: {conn_err}")
        return None
    except requests.exceptions.Timeout as timeout_err:
        print(f"Timeout error occurred: {timeout_err}")
        return None
    except requests.exceptions.RequestException as req_err:
        print(f"An error occurred during the API request: {req_err}")
        return None
    except ValueError as json_err:
        print(f"JSON decode error: {json_err} - Response text: {response.text}")
        return None
```text
### 步驟 3.4 - 設定 URL 路由

我們需要為應用程式設定兩個 URL 路由：一個用於顯示主頁面，另一個用於提供 AJAX 請求的股票數據。

首先，編輯 `stock_viewer/urls.py` 檔案，包含 `stocks` 應用程式的 URL：

```python
# stock_viewer/urls.py

from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('stocks/', include('stocks.urls')), # 包含 stocks 應用程式的 URL
]
```text
然後，在 `stocks` 應用程式目錄下建立一個新檔案 `stocks/urls.py`：

```python
# stocks/urls.py

from django.urls import path
from . import views

urlpatterns = [
    path('', views.index, name='index'),
    path('get_price/<str:symbol>/', views.get_stock_data, name='get_stock_data'),
]
```text
### 步驟 3.5 - 建立視圖函式

現在，我們來建立處理這些 URL 請求的視圖函式。

編輯 `stocks/views.py` 檔案：

```python
# stocks/views.py

from django.shortcuts import render
from django.http import JsonResponse
from .services import get_stock_quote

def index(request):
    """
    渲染主頁面，顯示股票查詢介面。
    """
    initial_symbol = "IBM" # 設定一個預設的股票代碼
    initial_data = None
    if initial_symbol:
        initial_data = get_stock_quote(initial_symbol)

    context = {
        'initial_symbol': initial_symbol,
        'initial_data': initial_data
    }
    return render(request, 'stocks/index.html', context)

def get_stock_data(request, symbol):
    """
    處理 AJAX 請求，返回指定股票代碼的 JSON 格式數據。
    """
    if request.method == 'GET':
        quote = get_stock_quote(symbol.upper()) # 轉換為大寫以符合 API 要求
        if quote:
            return JsonResponse({'success': True, 'data': quote})
        else:
            return JsonResponse({'success': False, 'message': 'Could not retrieve stock data. Check symbol or API limits.'}, status=404)
    return JsonResponse({'success': False, 'message': 'Invalid request method.'}, status=400)
```text
### 步驟 3.6 - 建立 HTML 模板

我們需要建立一個 HTML 模板來顯示使用者介面，並使用 JavaScript 來處理非同步的股價更新。

在 `stocks` 應用程式目錄下建立 `templates/stocks` 資料夾，然後在其中建立 `index.html` 檔案：

```html
<!-- stocks/templates/stocks/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時股價查詢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0056b3; margin-bottom: 30px; }
        .input-group { display: flex; margin-bottom: 20px; }
        .input-group input { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; font-size: 16px; }
        .input-group button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 0 4px 4px 0; cursor: pointer; font-size: 16px; }
        .input-group button:hover { background-color: #0056b3; }
        .stock-info { border: 1px solid #eee; padding: 20px; border-radius: 8px; background-color: #f9f9f9; }
        .stock-info p { margin: 8px 0; font-size: 1.1em; }
        .stock-info p strong { color: #555; }
        .price { font-size: 2.5em; font-weight: bold; color: #28a745; margin-bottom: 10px; text-align: center; }
        .change { font-size: 1.2em; text-align: center; }
        .change.positive { color: #28a745; }
        .change.negative { color: #dc3545; }
        .error-message { color: #dc3545; text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>即時股價查詢</h1>

        <div class="input-group">
            <input type="text" id="stockSymbol" placeholder="輸入股票代碼 (e.g., IBM, MSFT)" value="`{{ initial_symbol|default:'IBM'  }}`">
            <button id="searchButton">查詢</button>
        </div>

        <div id="stockData" class="stock-info">
            <p><strong>股票代碼:</strong> <span id="displaySymbol">N/A</span></p>
            <p class="price" id="displayPrice">N/A</p>
            <p class="change" id="displayChange">N/A</p>
            <p><strong>開盤價:</strong> <span id="displayOpen">N/A</span></p>
            <p><strong>最高價:</strong> <span id="displayHigh">N/A</span></p>
            <p><strong>最低價:</strong> <span id="displayLow">N/A</span></p>
            <p><strong>成交量:</strong> <span id="displayVolume">N/A</span></p>
            <p><strong>前收盤價:</strong> <span id="displayPreviousClose">N/A</span></p>
            <p><strong>更新時間:</strong> <span id="displayLastUpdated">N/A</span></p>
        </div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        // 注意：由於本教學文章嚴格限制不使用 Django 模板語法 `{{  }}`，
        // 故 `get_stock_data` 的 URL 在此直接寫死為相對路徑。
        // 在真實 Django 專案中，通常會使用 ``[Django URL pattern]``
        // 然後在 JavaScript 中替換 PLACEHOLDER。
        // 為避免與 Jekyll 衝突，此處直接使用相對路徑來簡化。
        const API_BASE_URL = "/stocks/get_price/";
        let currentSymbol = document.getElementById('stockSymbol').value || 'IBM';
        let fetchInterval; // 用於儲存 setInterval ID，以便清除

        const displaySymbol = document.getElementById('displaySymbol');
        const displayPrice = document.getElementById('displayPrice');
        const displayChange = document.getElementById('displayChange');
        const displayOpen = document.getElementById('displayOpen');
        const displayHigh = document.getElementById('displayHigh');
        const displayLow = document.getElementById('displayLow');
        const displayVolume = document.getElementById('displayVolume');
        const displayPreviousClose = document.getElementById('displayPreviousClose');
        const displayLastUpdated = document.getElementById('displayLastUpdated');
        const errorMessageDiv = document.getElementById('errorMessage');

        function showErrorMessage(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.style.display = 'block';
        }

        function hideErrorMessage() {
            errorMessageDiv.style.display = 'none';
        }

        async function fetchStockData(symbol) {
            hideErrorMessage();
            document.getElementById('stockData').style.display = 'block'; // 確保數據區可見

            try {
                const response = await fetch(`${API_BASE_URL}${symbol}/`);
                const data = await response.json();

                if (data.success && data.data) {
                    const stock = data.data;

                    displaySymbol.textContent = stock.symbol || 'N/A';
                    displayPrice.textContent = parseFloat(stock.price).toFixed(2) || 'N/A';
                    displayOpen.textContent = parseFloat(stock.open).toFixed(2) || 'N/A';
                    displayHigh.textContent = parseFloat(stock.high).toFixed(2) || 'N/A';
                    displayLow.textContent = parseFloat(stock.low).toFixed(2) || 'N/A';
                    displayVolume.textContent = parseInt(stock.volume).toLocaleString() || 'N/A';
                    displayPreviousClose.textContent = parseFloat(stock.previous_close).toFixed(2) || 'N/A';
                    displayLastUpdated.textContent = stock.latest_trading_day || 'N/A';

                    // 處理漲跌幅
                    const change = parseFloat(stock.change);
                    const changePercent = stock.change_percent; // 例如 "0.5000%"
                    displayChange.textContent = `${change.toFixed(2)} (${changePercent})`;

                    displayChange.classList.remove('positive', 'negative');
                    if (change > 0) {
                        displayChange.classList.add('positive');
                    } else if (change < 0) {
                        displayChange.classList.add('negative');
                    }
                } else {
                    showErrorMessage(data.message || '獲取股票數據失敗。請檢查股票代碼或稍後再試。');
                    document.getElementById('stockData').style.display = 'none'; // 隱藏數據區
                }
            } catch (error) {
                console.error('Error fetching stock data:', error);
                showErrorMessage('網路錯誤或服務器無回應。請稍後再試。');
                document.getElementById('stockData').style.display = 'none'; // 隱藏數據區
            }
        }

        function startFetching(symbol) {
            // 清除之前的間隔定時器，避免多個同時運行
            if (fetchInterval) {
                clearInterval(fetchInterval);
            }
            currentSymbol = symbol;
            fetchStockData(currentSymbol); // 立即獲取一次
            // 每 15 秒更新一次數據（Alpha Vantage 免費版限制頻率）
            fetchInterval = setInterval(() => fetchStockData(currentSymbol), 15000);
        }

        // 頁面載入時，如果 initial_symbol 有值，則開始查詢
        document.addEventListener('DOMContentLoaded', () => {
            const initialSymbol = document.getElementById('stockSymbol').value;
            if (initialSymbol) {
                // 如果 Django 傳入的 initial_data 不為空，則先顯示它
                // 由於不能使用 `{{  }}`，我們假設需要從頭開始發送請求
                startFetching(initialSymbol);
            }
        });

        document.getElementById('searchButton').addEventListener('click', () => {
            const symbolInput = document.getElementById('stockSymbol').value.trim().toUpperCase();
            if (symbolInput) {
                startFetching(symbolInput);
            } else {
                showErrorMessage('請輸入有效的股票代碼。');
            }
        });

        document.getElementById('stockSymbol').addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                document.getElementById('searchButton').click();
            }
        });

    </script>
</body>
</html>
```text
### 步驟 3.7 - 運行應用程式

現在您可以運行 Django 開發伺服器並測試您的應用程式了。

```bash
# 在專案根目錄下 (stock_viewer 所在的目錄)
python manage.py runserver
```text
打開您的網頁瀏覽器，導航到 `http://127.0.0.1:8000/stocks/`。您應該會看到一個輸入框，您可以輸入股票代碼（例如 `IBM`, `MSFT`, `AAPL`）並點擊「查詢」按鈕來查看即時股價。數據將會每隔 15 秒自動更新。

## 4. 常見錯誤與解法 (Common Errors and Solutions)

在開發過程中，您可能會遇到一些常見問題：

*   **`ModuleNotFoundError: No module named 'requests'`**
    *   **原因**: 您還沒有安裝 `requests` 函式庫。
    *   **解法**: 在您的虛擬環境中執行 `pip install requests`。
*   **`ModuleNotFoundError: No module named 'stocks'` (當您運行 `runserver` 時)**
    *   **原因**: 您沒有在 `stock_viewer/settings.py` 的 `INSTALLED_APPS` 中加入 `stocks` 應用程式。
    *   **解法**: 確保 `INSTALLED_APPS = ['...', 'stocks',]` 這一行存在。
*   **API Key 相關錯誤 (例如 API 返回錯誤訊息或 403/429 狀態碼)**
    *   **原因**:
        1.  您的 Alpha Vantage API 金鑰無效或輸入錯誤。
        2.  您超出了 Alpha Vantage 免費層級的 API 請求限制（每分鐘 5 次請求，每天 500 次請求）。
        3.  網路連接問題。
    *   **解法**:
        1.  仔細檢查 `settings.py` 中的 `ALPHA_VANTAGE_API_KEY` 是否正確。
        2.  等待一段時間，或考慮升級 API 方案。
        3.  檢查您的網路連接。
        4.  檢查 `stocks/services.py` 中的 `base_url` 和 `params` 是否與 Alpha Vantage 的 API 文件一致。
*   **`JSONDecodeError: Expecting value: line 1 column 1 (char 0)`**
    *   **原因**: API 返回的不是有效的 JSON 格式數據。這通常發生在 API 服務器返回錯誤頁面、限流提示或網路中斷時。
    *   **解法**: 檢查 `stocks/services.py` 中 `response.json()` 之前的 `response.raise_for_status()` 是否成功，並可以列印 `response.text` 來查看原始的響應內容，以便診斷問題。
*   **前端 JavaScript 不更新或無響應**
    *   **原因**:
        1.  JavaScript 程式碼中存在錯誤（例如，變數名拼寫錯誤，DOM 元素 ID 不匹配）。
        2.  API 端點 URL 不正確（例如，`API_BASE_URL` 錯誤）。
        3.  瀏覽器的同源策略限制（CORS，但在同一個 Django 專案內通常不會遇到）。
    *   **解法**:
        1.  打開瀏覽器的開發者工具 (通常是按 F12)，檢查 Console (控制台) 選項卡是否有 JavaScript 錯誤。
        2.  在 Network (網路) 選項卡中檢查 AJAX 請求是否成功發送並收到正確的響應。
        3.  確認 HTML 模板中的 ID 與 JavaScript 程式碼中使用的 ID 一致。
*   **`Page not found (404)` 當訪問 `/stocks/` 或 `/stocks/get_price/SYMBOL/` 時**
    *   **原因**: URL 配置不正確。
    *   **解法**: 檢查 `stock_viewer/urls.py` 和 `stocks/urls.py` 中的 `urlpatterns` 是否正確配置，特別是 `include('stocks.urls')` 和 `path('get_price/<str:symbol>/', ...)`。

## 5. 延伸應用與學習資源 (Extensions and Learning Resources)

這個即時股價應用程式只是一個基礎，您可以根據需求進行許多延伸和改進：

*   **真正的即時更新 (WebSockets)**: 考慮使用 Django Channels 實作 WebSocket，這樣服務器可以在股價變動時主動推送數據給客戶端，而非客戶端週期性地拉取數據。
*   **歷史數據與圖表**:
    *   將股票的歷史數據儲存到資料庫 (例如 PostgreSQL 或 MySQL) 中。
    *   整合前端圖表函式庫，例如 [Chart.js](https://www.chartjs.org/) 或 [D3.js](https://d3js.org/)，來繪製股價走勢圖。
*   **使用者認證與追蹤列表**:
    *   新增使用者註冊和登入功能。
    *   允許使用者建立自己的股票追蹤列表，並儲存到資料庫中。
*   **更多股票數據**: Alpha Vantage 提供不只即時報價，還有日線、週線、月線等歷史數據，以及基本面數據。您可以擴展您的應用程式來顯示更多資訊。
*   **更完善的錯誤處理和使用者體驗**:
    *   為使用者提供更友好的錯誤訊息。
    *   增加載入指示器 (loading spinner)，在數據載入時顯示。
    *   實現輸入框的自動完成功能，方便使用者輸入股票代碼。
*   **環境變數管理**: 使用 [python-dotenv](https://github.com/theskumar/python-dotenv) 函式庫來管理敏感配置，如 API 金鑰，這在部署到生產環境時尤為重要。
*   **部署應用程式**: 將您的 Django 應用程式部署到雲服務平台，如 Heroku、AWS Elastic Beanstalk、Google Cloud Run 或 Vercel (對於簡單的靜態+API應用)。

**學習資源**:

*   **Django 官方文件**: [https://docs.djangoproject.com/en/stable/](https://docs.djangoproject.com/en/stable/) - 最權威的學習資源。
*   **Alpha Vantage API 文件**: [https://www.alphavantage.co/documentation/](https://www.alphavantage.co/documentation/) - 了解更多 API 功能和限制。
*   **MDN Web Docs (JavaScript, Fetch API)**: [https://developer.mozilla.org/zh-TW/docs/Web](https://developer.mozilla.org/zh-TW/docs/Web) - 學習前端技術的寶庫。
*   **Real Python 網站**: [https://realpython.com/](https://realpython.com/) - 許多關於 Python 和 Django 的優質教學。
*   **Traversy Media (YouTube)**: 提供大量 Web 開發相關的影片教學，包括 Django 和前端技術。

希望這篇文章能幫助您成功建立您的第一個即時股價應用程式，並激發您探索更多 Web 開發的可能性！
```