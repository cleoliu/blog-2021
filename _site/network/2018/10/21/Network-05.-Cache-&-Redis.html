<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>[Network] 05. Cache & Redis</title>
	
	<meta name="description" content="瀏覽器收到這個 Response 之後就會把這個資源給快取起來...">
	
	<meta name="author" content="Cleo">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">
	<link rel="shortcut icon" href="/assets/ico/favicon.png">
	<!-- Le fav and touch icons -->
	<!-- Update these with your own images
	<link rel="shortcut icon" href="images/favicon.ico">
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->

	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header" style="background-image: url(/assets/img/bg.jpg); background-size: cover; background-position: center;
		">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/cleoliu">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:second934@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="/assets/img/pexels-photo-1449638.jpeg" width="150" height="150" class="img-circle" />
			</a>
			<a class="navbar-brand" href="//aboutme.html" style="color: white;text-transform: uppercase;">
				[Network] 05. Cache & Redis
			</a>

		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/history.html">History</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li><a href="/history.html"><i class="fa fa-clock-o"></i>History</a></li>
			<li><a href="/categories.html"><i class="fa fa-folder"></i>Categories</a></li>
			<li><a href="/tags.html"><i class="fa fa-tags"></i>Tags</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="/assets/img/pexels-photo-1449638.jpeg" width="150" height="150" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/aboutme.html">Cleo</a>
    </h3>
</header>


<div id="bio" class="text-center">
	Writing and Learning!
</div>


<div id="contact-list" class="text-center">
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/cleoliu">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:second934@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/cleo-l-770422130">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>[Network] 05. Cache & Redis </h1>
</div>
	
<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   October 
	   21st,
	     
		 2018
		 <span id="busuanzi_container_page_pv" style="display: inline;">
				| Viewd <span id="busuanzi_value_page_pv">10</span> times.
			</span>
	 </span>
	  <div class="article_body">
	  <h2 id="前端-cache">前端 Cache</h2>

<blockquote>
  <p><strong>Client 瀏覽器緩存</strong>，不再去向 Server 溝通。（存放在：瀏覽器 &gt; F12 &gt; App &gt; Cache）</p>
</blockquote>

<p><img src="https://s3.amazonaws.com/notejoy/note_images/99994.1.Image%202018-08-24%20at%20%E4%B8%8B%E5%8D%883.04.42.png" alt="" /></p>

<ul>
  <li><strong>瀏覽器收到這個 Response 之後就會把這個資源給快取起來</strong>，當下一次使用者再度造訪這個頁面或是要求這個圖片的資源的時候，瀏覽器會檢視「現在的時間」是否有超過這個 Expires。如果沒有超過的話，那瀏覽器「不會發送任何 Request」，而是直接從電腦裡面已經存好的 Cache 拿資料。</li>
  <li>舊的 Cache 期限過了就會被刪除。</li>
  <li>HTTP Response Header 裡面加上一個 Expires 的字段，裡面就是這個 Cache 到期的時間，例如說：
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Expires: Wed, 21 Oct 2017 07:28:00 GMT
</code></pre></div>    </div>
  </li>
  <li><strong>CSRF</strong> 攻擊<a href="https://blog.techbridge.cc/2017/02/25/csrf-introduction/">1</a>：因為沒有限制網域，所以在導向攻擊者頁面時，Cache 沒過期就可能會被竊取 Cache 的資料。</li>
</ul>

<p><br /><br /></p>

<hr />

<h2 id="memorycache--1">MemoryCache  <a href="https://dotblogs.com.tw/wasichris/2015/11/14/153922">1</a></h2>

<blockquote>
  <p>系統資料來自<strong>遠端資料庫</strong>及 WebAPI 等，若頻繁地從資料源撈取資料，可能造成資料提供者的負擔，可使用 Cache 來增加資料讀取效率。</p>
</blockquote>

<p><img src="https://az787680.vo.msecnd.net/user/wasichris/1511/C-MemoryCache_ACF5/image_thumb.png" alt="" /></p>

<ul>
  <li>電商網站的首頁可能會有很多商品，如果你今天每一個訪客到首頁你都去資料庫重新抓一次所有的資料，那對資料庫的負擔會非常非常大，為了增加處理速度跟效率，<strong>Server 會將一些 Request 的內容儲存在某個地方</strong>，通常這地方稱做為 Cache，之後<strong>如果有 Request 想要同樣的內容，就直接傳送給它</strong>。（這樣 Server 就不用每次都根據 Request 去 DB 或其它地方收集資訊再 Response）</li>
  <li>以資料時效性及記憶體空間來換取資料獲得效能，所以<strong>可能資料不同步</strong>(資料源與快取)。</li>
  <li>程式開發需考量何時要收回快取來向資料源重新撈取資料。</li>
</ul>

<p><br /><br /></p>

<h3 id="net-40--systemruntimecaching-objectcache-1">.NET 4.0  System.Runtime.Caching ObjectCache <a href="https://msdn.microsoft.com/zh-tw/library/dd780614(v=vs.110).aspx">1</a></h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DataSourceProvider</span>
<span class="p">{</span>
    <span class="c1">// fields</span>
    <span class="k">private</span> <span class="n">ObjectCache</span> <span class="n">_cache</span> <span class="p">=</span> <span class="n">MemoryCache</span><span class="p">.</span><span class="n">Default</span><span class="p">;</span> 

    <span class="c1">// proterties</span>
    <span class="k">public</span> <span class="n">CacheEntryRemovedCallback</span> <span class="n">OnFileContentsCacheRemove</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">PolicyType</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FileContents</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="s">"FileContents"</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">fileContents</span> <span class="p">=</span> <span class="n">_cache</span><span class="p">[</span><span class="n">cacheKey</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">fileContents</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">// load file</span>
                <span class="kt">string</span> <span class="n">filePath</span> <span class="p">=</span> <span class="s">@"D:\Holidays.txt"</span><span class="p">;</span>
                <span class="n">fileContents</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllText</span><span class="p">(</span><span class="n">filePath</span><span class="p">,</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">);</span> 

                <span class="c1">// set policy (when to remove cache)</span>
                <span class="kt">var</span> <span class="n">policy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CacheItemPolicy</span><span class="p">();</span>
                <span class="n">policy</span><span class="p">.</span><span class="n">RemovedCallback</span> <span class="p">=</span> <span class="n">OnFileContentsCacheRemove</span><span class="p">;</span>

                <span class="c1">// dynamic change policy for testing </span>
                <span class="k">switch</span> <span class="p">(</span><span class="n">PolicyType</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">case</span> <span class="s">"1"</span><span class="p">:</span>
                        <span class="c1">// 距離設定快取時間超過2秒後，回收快取</span>
                        <span class="n">policy</span><span class="p">.</span><span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddSeconds</span><span class="p">(</span><span class="m">2</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">case</span> <span class="s">"2"</span><span class="p">:</span>
                        <span class="c1">// 3秒期限內未使用快取時，回收快取</span>
                        <span class="n">policy</span><span class="p">.</span><span class="n">SlidingExpiration</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="nf">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="k">default</span><span class="p">:</span>
                        <span class="c1">// 資料異動時，回收快取</span>
                        <span class="n">policy</span><span class="p">.</span><span class="n">ChangeMonitors</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">HostFileChangeMonitor</span><span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span> <span class="p">{</span> <span class="n">filePath</span> <span class="p">}));</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="c1">// set cache</span>
                <span class="n">_cache</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">fileContents</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">fileContents</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /><br /></p>

<hr />

<h2 id="cdn-content-delivery-network內容傳遞網路-1">CDN (Content delivery network，內容傳遞網路) <a href="http://newaurora.pixnet.net/blog/post/128995999-cdn">1</a></h2>

<blockquote>
  <p>Web Sever 把產生的內容放入各個節點的機房中，各地用戶在讀取網站資料的時後會依據所在地去最近的機房拿資料，這樣一來就算Web Sever架在美國或歐洲，也不影響用戶讀取網站的速度。</p>
</blockquote>

<p><img src="https://s3.amazonaws.com/notejoy/note_images/99994.1.Image%202018-09-05%20at%20%E4%B8%8A%E5%8D%8810.46.23.png" alt="" /></p>

<ul>
  <li>加速網頁瀏覽效能：因為已經將緩存資料放在最近的機房中，不需要重新像伺服器讀取。</li>
  <li>有效分流(頻寬)：當所有用戶都不再向同一個伺服器讀取資料，大幅降低集中流量。</li>
  <li>網站穩定度：網站流量分散後，網站的穩定度大幅提高，即使短暫當機也不怕用戶無法使用。</li>
  <li>安全性增加：因網站透過CDN分散出去，駭客較難直接攻擊網站本體。</li>
</ul>

<p><br /><br /></p>

<hr />

<h2 id="database-redis">Database Redis</h2>

<blockquote>
  <p>短網址、統計系統資料不須存放太久的。</p>
</blockquote>

<p><img src="https://s3.amazonaws.com/notejoy/note_images/99994.1.Image%202018-09-04%20at%20%E4%B8%8B%E5%8D%8811.41.58.png" alt="" /></p>

<ul>
  <li>Redis 是一個 in-memory 的 <strong>key-value 快取 Database</strong>，因此常常被用在需要快取（Cache）一些資料的場合，做為 Cache Server，可以減輕許多後端資料庫的壓力。</li>
  <li>是一個開源、支援網路、基於記憶體、鍵值對儲存資料庫，使用 ANSI C 編寫。</li>
  <li>可用在叢集架構有多台 Server，因為不同 Server 的資料不共用，那就存在 Server 共同對應的 Redis Server。</li>
  <li>從 <strong>Local Server（ex.DB）</strong>拿些資料（<strong>如一些用戶的key/瀏覽器</strong>）<strong>放在 Redis Server</strong>，之後要用就不用再去 Server 拿，直接去 Redis 要。</li>
  <li>減少記憶體的使用量，只保持某些「熱資料」會存在 Redis，其他比較冷門、不常被訪問的數據，就存在 Database，等到被訪問的時候再寫到 Redis 即可。</li>
</ul>

<p><br /><br /></p>

<h3 id="短網址實現方式1">短網址實現方式：<a href="https://blog.techbridge.cc/2016/06/18/redis-introduction/">1</a></h3>

<ol>
  <li>使用者新增短網址，系統亂數產生 abc123 對應到 http://techbridge.cc</li>
  <li>把 key=abc123, value=http://techbridge.cc 寫進資料庫</li>
  <li>同上，但是是儲存在 Redis</li>
  <li>當有使用者點擊：abc123 這個網址時，先去 Redis 查有沒有這個 key</li>
  <li>有的話，redirect 到對應的網址</li>
  <li>沒有的話，只好去資料庫查，查完之後記得寫一份到 Redis</li>
  <li>可以新增一個 Expire time 的參數，當這個時間一到之後，這個 key 就會自動被清除。</li>
</ol>

<p><br /><br /></p>

<h3 id="net-webconfig-redis-連線設定">.NET Web.config Redis 連線設定</h3>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="k">add</span> <span class="n">key</span><span class="p">=</span><span class="s">"RedisConnectionString"</span>
 <span class="k">value</span><span class="p">=</span><span class="s">"192.168.50.115:6379,abortConnect=false,connectRetry=3,connectTimeout=10000,defaultDatabase=10,syncTimeout=3000,version=3.2.1,responseTimeout=3000"</span><span class="p">/&gt;</span>
</code></pre></div></div>
<p><br /><br /></p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#Network-ref">
					Network <span>(6)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#觀念-ref">
					觀念 <span>(12)</span>
					,
					</a>
				</li>
			 
				<li>
					<a href="/tags.html#Network-ref">
					Network <span>(5)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="https://raw.githubusercontent.com/cleoliu/cleoliu.github.io/master/assets/img/pexels-photo-1449638.jpeg" width="150" height="150" class="img-rounded author-image" />
        <h4 class="section-title author-name">Cleo</h4>
        <p class="author-bio">Writing and Learning!</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/jekyll/2018/10/21/Jekyll-01.-Github%E5%80%8B%E4%BA%BA%E7%B6%B2%E7%AB%99-%E7%92%B0%E5%A2%83%E7%AF%87.html" title="[Jekyll] 01. Github個人網站-環境篇">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/network/2018/10/22/Network-06.-HTTP-%E6%9C%8D%E5%8B%99.html" title="[Network] 06. HTTP 服務">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2018 Cleo with <a href="http://jekyllrb.com/">Jekyll</a>.
				<span id="busuanzi_container_site_uv">You are the <span id="busuanzi_value_site_uv"></span>th visitor.
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'Cleo', 'auto');
  ga('send', 'pageview');
</script>

